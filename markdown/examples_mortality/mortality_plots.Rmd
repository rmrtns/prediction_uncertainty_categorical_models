---
title: "Mortality: Plots of discordant predictions, confusion matrices and crossover within confusion matrices"
output: html_document
date: "2024-05-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(seed = 200)
```

## Load libraries
```{r include=FALSE, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
```

## Import functions and variables.
```{r, include=FALSE, warning=FALSE, message=FALSE}
source('src/manuscript.R', local = manuscript <- new.env())
```

## Load discordance data validation_extern stats_with_ci.
```{r, echo=FALSE}
list_of_files_discordance <- 
  list.files(
    'out/mortality/simulations_discordance_aggregate_results/', 
    pattern = 'validation_extern_((bio_cv_|an_cv_|tot_cv_)(base|1dot5|\\d))_stats_with_ci.csv', 
    recursive = TRUE, 
    full.names = TRUE
  )

discordance_validation_extern_stats_with_ci <- bind_rows(
  lapply(list_of_files_discordance, manuscript$read_files)
) 
  
discordance_validation_extern_stats_with_ci <- manuscript$tidy_data(
  discordance_validation_extern_stats_with_ci
)
```

## Create plots for discordance data validation extern.
### Plot p97.5 of percentage discordant.
```{r, echo=FALSE}
plot_discordance_p97.5 <- manuscript$get_plot_by_cv_level(
  discordance_validation_extern_stats_with_ci,
  "percentage_discordant_p97.5",
  "p97.5 of percentage discordant (%)",
  c(0, 50)
)

plot_discordance_p97.5
```

### Plot percentage_discordant_above_05.
```{r, echo=FALSE}
plot_discordance_above_05 <- manuscript$get_plot_by_cv_level(
  discordance_validation_extern_stats_with_ci,
  "percentage_discordant_above_05",
  "percentage discordant >5% (%)",
  c(0, 25)
)

plot_discordance_above_05
```

### Plot probability discordant.
```{r, echo=FALSE}
plot_probability_discordant <- manuscript$get_plot_by_cv_level(
  discordance_validation_extern_stats_with_ci,
  "probability_discordant",
  "Probability discordant prediction (%)",
  c(0, 5)
)

plot_probability_discordant
```

### Combined plot.
```{r, echo=FALSE}
plot_1 <- ggarrange(
  plotlist = list(plot_discordance_p97.5, plot_probability_discordant),
  ncol = 2,
  common.legend = TRUE,
  labels = "AUTO"
)

plot_1

ggsave(
  filename = "mortality_figure_discordance.tiff",
  plot = plot_1,
  path = "manuscript/plots/",
  width = 176,
  height = 105,
  units = "mm",
  compression = "lzw"
)
```

### Combined plot.
```{r, echo=FALSE}
plot_2 <- ggarrange(
  plotlist = list(plot_discordance_above_05, plot_probability_discordant),
  ncol = 2,
  common.legend = TRUE,
  labels = "AUTO"
)

plot_2

ggsave(
  filename = "mortality_figure_discordance_dichotomised.tiff",
  plot = plot_2,
  path = "manuscript/plots/",
  width = 176,
  height = 105,
  units = "mm",
  compression = "lzw"
)
```

## Load confusion matrix data validation_extern stats_with_ci.
```{r, echo=FALSE}
list_of_files_confusion_matrix <- 
  list.files(
    'out/mortality/simulations_confusion_matrix_aggregate_results/', 
    pattern = 'validation_extern_((bio_cv_|an_cv_|tot_cv_)(base|1dot5|\\d))_stats_with_ci.csv', 
    recursive = TRUE, 
    full.names = TRUE
  )

confusion_matrix_validation_extern_stats_with_ci <- bind_rows(
  lapply(list_of_files_confusion_matrix, manuscript$read_files)
) 
  
confusion_matrix_validation_extern_stats_with_ci <- manuscript$tidy_data(
  confusion_matrix_validation_extern_stats_with_ci
)
```

## Create plots for discordance data validation extern.
### Plot sensitivity.
```{r, echo=FALSE}
plot_sensitivity <- manuscript$get_plot_by_cv_level(
  confusion_matrix_validation_extern_stats_with_ci,
  "sensitivity",
  "Sensitivity",
  c(0, 0.5)
)

plot_sensitivity
```

### Plot specificity.
```{r, echo=FALSE}
plot_specificity <- manuscript$get_plot_by_cv_level(
  confusion_matrix_validation_extern_stats_with_ci,
  "specificity",
  "Specificity",
  c(0.5, 1)
)

plot_specificity
```

### Combined plot.
```{r, echo=FALSE}
plot_3 <- ggarrange(
  plotlist = list(plot_sensitivity, plot_specificity),
  ncol = 2,
  common.legend = TRUE,
  labels = "AUTO"
)

plot_3

ggsave(
  filename = "mortality_figure_confusion_matrix.tiff",
  plot = plot_3,
  path = "manuscript/plots/",
  width = 176,
  height = 105,
  units = "mm",
  compression = "lzw"
)
```

## Load crossover data validation_extern stats_with_ci.
```{r, echo=FALSE}
list_of_files_crossover <- 
  list.files(
    'out/mortality/simulations_crossover_aggregate_results/', 
    pattern = 'validation_extern_((bio_cv_|an_cv_|tot_cv_)(base|1dot5|\\d))_stats_with_ci.csv', 
    recursive = TRUE, 
    full.names = TRUE
  )

crossover_validation_extern_stats_with_ci <- bind_rows(
  lapply(list_of_files_crossover, manuscript$read_files)
) 
  
crossover_validation_extern_stats_with_ci <- manuscript$tidy_data(
  crossover_validation_extern_stats_with_ci
)
```

## Create plots for crossover data validation extern.
### Plot probability discordant false negative minus true positive.
```{r, echo=FALSE}
plot_fn_minus_tp_percentage_point_diff <- manuscript$get_plot_by_cv_level(
  crossover_validation_extern_stats_with_ci,
  "fn_minus_tp_percentage_point_diff",
  "Probability discordant \nfalse negative - true positive (%)",
  c(-1, 1)
)

plot_fn_minus_tp_percentage_point_diff
```

### Plot probability discordant false positive minus true negative.
```{r, echo=FALSE}
plot_fp_minus_tn_percentage_point_diff <- manuscript$get_plot_by_cv_level(
  crossover_validation_extern_stats_with_ci,
  "fp_minus_tn_percentage_point_diff",
  "Probability discordant \nfalse positive - true negative (%)",
  c(-1, 1)
)

plot_fp_minus_tn_percentage_point_diff
```

### Combined plot.
```{r, echo=FALSE}
plot_4 <- ggarrange(
  plotlist = list(
    plot_fn_minus_tp_percentage_point_diff, 
    plot_fp_minus_tn_percentage_point_diff
  ),
  ncol = 2,
  common.legend = TRUE,
  labels = "AUTO"
)

plot_4

ggsave(
  filename = "mortality_figure_crossover.tiff",
  plot = plot_4,
  path = "manuscript/plots/",
  width = 176,
  height = 105,
  units = "mm",
  compression = "lzw"
)
```

### Combined plot.
```{r, echo=FALSE}
plot_5 <- ggarrange(
  plotlist = list(
    plot_sensitivity,
    plot_specificity,
    plot_fn_minus_tp_percentage_point_diff, 
    plot_fp_minus_tn_percentage_point_diff
  ),
  ncol = 2,
  nrow = 2,
  common.legend = TRUE,
  labels= "AUTO"
)

plot_5

ggsave(
  filename = "mortality_figure_confusion_matrix_crossover.tiff",
  plot = plot_5,
  path = "manuscript/plots/",
  width = 176,
  height = 210,
  units = "mm",
  compression = "lzw"
)
```